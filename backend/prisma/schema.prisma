generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SYSTEM_ADMIN
  SENIOR_MANAGER
  MANAGER
  MEMBER
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum NotificationType {
  BUDGET_WARNING
  BUDGET_CRITICAL
  BUDGET_EXCEEDED
  REQUEST_APPROVED
  REQUEST_REJECTED
  CONTRACT_EXPIRING
  SYSTEM_ALERT
  SUPPLIER_REQUEST
}

enum Branch {
  CHESSINGTON
  ROYSTON
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  budget      Decimal  @default(0.00) @db.Decimal(15, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users               User[]
  categories          SpendingCategory[]
  additionalUserRoles UserDepartmentRole[]
  suppliers           Supplier[]

  parentId String?
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  children Department[] @relation("DepartmentHierarchy")
}

model SpendingCategory {
  id           String   @id @default(uuid())
  name         String
  description  String?
  parentId     String?
  departmentId String
  branch       Branch
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  department Department         @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  parent     SpendingCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  children   SpendingCategory[] @relation("CategoryHierarchy")
  requests   PurchaseRequest[]

  @@index([departmentId])
  @@index([parentId])
  @@index([branch])
}

model User {
  id                String     @id @default(uuid())
  email             String     @unique
  password          String
  name              String
  role              UserRole   @default(MEMBER)
  status            UserStatus @default(PENDING)
  invitationToken   String?    @unique
  invitationExpires DateTime?
  departmentId      String?
  managerId         String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  department      Department?          @relation(fields: [departmentId], references: [id])
  manager         User?                @relation("ManagerReportee", fields: [managerId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  reportees       User[]               @relation("ManagerReportee")
  additionalRoles UserDepartmentRole[]

  auditLogs       AuditLog[]
  interactions    InteractionLog[]
  messages        Message[]
  approvals       PurchaseRequest[] @relation("Approver")
  requests        PurchaseRequest[]
  approvalHistory ApprovalHistory[]
  contracts       Contract[]
  notifications   Notification[]

  reviews            Review[]
  requestedSuppliers Supplier[] @relation("SupplierRequester")

  @@index([departmentId])
  @@index([managerId])
}

model UserDepartmentRole {
  id           String   @id @default(uuid())
  userId       String
  departmentId String
  role         UserRole
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
}

model Supplier {
  id           String             @id @default(uuid())
  name         String
  category     String
  status       String             @default("Pending")
  contactName  String?
  contactEmail String?
  logoUrl      String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  interactions InteractionLog[]
  messages     Message[]
  documents    SupplierDocument[]
  orders       PurchaseOrder[]
  requests     PurchaseRequest[]
  contracts    Contract[]
  details      SupplierDetails?
  reviews      Review[]
  requesterId  String?
  requester    User?              @relation("SupplierRequester", fields: [requesterId], references: [id])
  departments  Department[]

  @@index([status])
  @@index([category])
  @@index([createdAt])
}

model SupplierDetails {
  id            String   @id @default(uuid())
  supplierId    String   @unique
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?
  paymentTerms  String?  @default("Net 30")
  paymentMethod String?  @default("Wire Transfer")
  internalNotes String?  @db.Text
  rating        Decimal? @db.Decimal(3, 2)
  reviewCount   Int?     @default(0)

  // Performance Metrics
  deliveryDelayAverage Int? @default(0) // in days
  qualityScore         Int? @default(100) // 0-100
  communicationScore   Int? @default(100) // 0-100

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  supplier  Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

model SupplierDocument {
  id         String    @id @default(uuid())
  supplierId String
  title      String
  type       String // e.g., 'Tax', 'Insurance', 'Contract', 'Certification'
  url        String
  expiryDate DateTime?
  status     String // 'Valid', 'Expiring Soon', 'Expired'
  uploadDate DateTime  @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
}

model Message {
  id         String    @id @default(uuid())
  supplierId String
  userId     String
  subject    String?
  content    String    @db.Text
  isFromUser Boolean   @default(true)
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  supplier   Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id])

  @@index([supplierId, createdAt])
  @@index([userId], map: "Message_userId_fkey")
}

model InteractionLog {
  id          String   @id @default(uuid())
  supplierId  String
  userId      String
  eventType   String
  title       String
  description String?  @db.Text
  eventDate   DateTime
  createdAt   DateTime @default(now())
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@index([supplierId, eventDate])
  @@index([userId], map: "InteractionLog_userId_fkey")
}

model PurchaseRequest {
  id                   String        @id @default(uuid())
  requesterId          String
  status               RequestStatus @default(IN_PROGRESS)
  totalAmount          Decimal       @db.Decimal(10, 2)
  reason               String?
  categoryId           String?
  currentApproverId    String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  approverId           String?
  supplierId           String?
  budgetCategory       String?
  deliveryLocation     String?
  expectedDeliveryDate DateTime?
  branch               Branch        @default(CHESSINGTON)

  order           PurchaseOrder?
  approver        User?             @relation("Approver", fields: [approverId], references: [id])
  requester       User              @relation(fields: [requesterId], references: [id])
  supplier        Supplier?         @relation(fields: [supplierId], references: [id])
  category        SpendingCategory? @relation(fields: [categoryId], references: [id])
  items           RequestItem[]
  approvalHistory ApprovalHistory[]
  attachments     Attachment[]

  @@index([approverId], map: "PurchaseRequest_approverId_fkey")
  @@index([requesterId], map: "PurchaseRequest_requesterId_fkey")
  @@index([supplierId], map: "PurchaseRequest_supplierId_fkey")
  @@index([categoryId])
  @@index([currentApproverId])
  @@index([branch])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
}

model ApprovalHistory {
  id         String   @id @default(uuid())
  requestId  String
  approverId String
  action     String // APPROVED, REJECTED, FORWARDED
  comments   String?  @db.Text
  createdAt  DateTime @default(now())

  request  PurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  approver User            @relation(fields: [approverId], references: [id])

  @@index([requestId])
  @@index([approverId])
}

model Attachment {
  id         String   @id @default(uuid())
  requestId  String
  filename   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  uploadedAt DateTime @default(now())

  request PurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
}

model RequestItem {
  id          String          @id @default(uuid())
  requestId   String
  description String
  quantity    Int
  unitPrice   Decimal         @db.Decimal(10, 2)
  totalPrice  Decimal         @db.Decimal(10, 2)
  request     PurchaseRequest @relation(fields: [requestId], references: [id])

  @@index([requestId], map: "RequestItem_requestId_fkey")
}

model PurchaseOrder {
  id          String          @id @default(uuid())
  requestId   String          @unique
  supplierId  String
  status      OrderStatus     @default(IN_PROGRESS)
  totalAmount Decimal         @db.Decimal(10, 2)
  issuedAt    DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  request     PurchaseRequest @relation(fields: [requestId], references: [id])
  supplier    Supplier        @relation(fields: [supplierId], references: [id])

  @@index([supplierId], map: "PurchaseOrder_supplierId_fkey")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  resource  String
  details   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "AuditLog_userId_fkey")
}

enum RequestStatus {
  IN_PROGRESS
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  IN_PROGRESS
  SENT
  PARTIAL
  COMPLETED
  CANCELLED
}

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  TERMINATED
  RENEWED
}

model Contract {
  id             String         @id @default(uuid())
  contractNumber String         @unique
  title          String
  supplierId     String
  ownerId        String
  status         ContractStatus @default(DRAFT)

  // Contract Terms
  startDate        DateTime
  endDate          DateTime
  renewalDate      DateTime?
  autoRenew        Boolean   @default(false)
  noticePeriodDays Int       @default(30)

  // Financial
  totalValue   Decimal @db.Decimal(12, 2)
  currency     String  @default("GBP")
  paymentTerms String?

  // Documents
  documentUrl  String?
  documentName String?

  // Details
  description String? @db.Text
  terms       String? @db.Text
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplier Supplier @relation(fields: [supplierId], references: [id])
  owner    User     @relation(fields: [ownerId], references: [id])

  @@index([supplierId])
  @@index([ownerId])
  @@index([status])
  @@index([endDate])
}

model Review {
  id         String   @id @default(uuid())
  supplierId String
  userId     String
  rating     Int // 1-5
  comment    String   @db.Text
  createdAt  DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([userId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  metadata  Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}
