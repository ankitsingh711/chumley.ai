generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SYSTEM_ADMIN
  SENIOR_MANAGER
  MANAGER
  MEMBER
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users              User[]
  categories         SpendingCategory[]
  additionalUserRoles UserDepartmentRole[]
}

model SpendingCategory {
  id           String  @id @default(uuid())
  name         String
  description  String?
  parentId     String?
  departmentId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  department   Department         @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  parent       SpendingCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  children     SpendingCategory[] @relation("CategoryHierarchy")
  requests     PurchaseRequest[]
  
  @@index([departmentId])
  @@index([parentId])
}

model User {
  id           String            @id @default(uuid())
  email        String            @unique
  password     String
  name         String
  role         UserRole          @default(MEMBER)
  departmentId String?
  managerId    String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  department         Department?          @relation(fields: [departmentId], references: [id])
  manager            User?                @relation("ManagerReportee", fields: [managerId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  reportees          User[]               @relation("ManagerReportee")
  additionalRoles    UserDepartmentRole[]
  
  auditLogs          AuditLog[]
  interactions       InteractionLog[]
  messages           Message[]
  approvals          PurchaseRequest[]    @relation("Approver")
  requests           PurchaseRequest[]
  approvalHistory    ApprovalHistory[]
  
  @@index([departmentId])
  @@index([managerId])
}

model UserDepartmentRole {
  id           String     @id @default(uuid())
  userId       String
  departmentId String
  role         UserRole
  createdAt    DateTime   @default(now())
  
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, departmentId])
  @@index([userId])
  @@index([departmentId])
}

model Supplier {
  id           String            @id @default(uuid())
  name         String
  category     String
  status       String            @default("Pending")
  contactName  String?
  contactEmail String?
  logoUrl      String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  interactions InteractionLog[]
  messages     Message[]
  orders       PurchaseOrder[]
  requests     PurchaseRequest[]
  details      SupplierDetails?
}

model SupplierDetails {
  id            String   @id @default(uuid())
  supplierId    String   @unique
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?
  paymentTerms  String?  @default("Net 30")
  paymentMethod String?  @default("Wire Transfer")
  internalNotes String?  @db.Text
  rating        Decimal? @db.Decimal(3, 2)
  reviewCount   Int?     @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  supplier      Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

model Message {
  id         String    @id @default(uuid())
  supplierId String
  userId     String
  subject    String?
  content    String    @db.Text
  isFromUser Boolean   @default(true)
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  supplier   Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id])

  @@index([supplierId, createdAt])
  @@index([userId], map: "Message_userId_fkey")
}

model InteractionLog {
  id          String   @id @default(uuid())
  supplierId  String
  userId      String
  eventType   String
  title       String
  description String?  @db.Text
  eventDate   DateTime
  createdAt   DateTime @default(now())
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@index([supplierId, eventDate])
  @@index([userId], map: "InteractionLog_userId_fkey")
}

model PurchaseRequest {
  id                   String         @id @default(uuid())
  requesterId          String
  status               RequestStatus  @default(DRAFT)
  totalAmount          Decimal        @db.Decimal(10, 2)
  reason               String?
  categoryId           String?
  currentApproverId    String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  approverId           String?
  supplierId           String?
  budgetCategory       String?
  deliveryLocation     String?
  expectedDeliveryDate DateTime?
  
  order                PurchaseOrder?
  approver             User?              @relation("Approver", fields: [approverId], references: [id])
  requester            User               @relation(fields: [requesterId], references: [id])
  supplier             Supplier?          @relation(fields: [supplierId], references: [id])
  category             SpendingCategory?  @relation(fields: [categoryId], references: [id])
  items                RequestItem[]
  approvalHistory      ApprovalHistory[]
  attachments          Attachment[]

  @@index([approverId], map: "PurchaseRequest_approverId_fkey")
  @@index([requesterId], map: "PurchaseRequest_requesterId_fkey")
  @@index([supplierId], map: "PurchaseRequest_supplierId_fkey")
  @@index([categoryId])
  @@index([currentApproverId])
}

model ApprovalHistory {
  id         String          @id @default(uuid())
  requestId  String
  approverId String
  action     String          // APPROVED, REJECTED, FORWARDED
  comments   String?         @db.Text
  createdAt  DateTime        @default(now())
  
  request    PurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  approver   User            @relation(fields: [approverId], references: [id])
  
  @@index([requestId])
  @@index([approverId])
}

model Attachment {
  id         String          @id @default(uuid())
  requestId  String
  filename   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  uploadedAt DateTime        @default(now())
  
  request    PurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  @@index([requestId])
}

model RequestItem {
  id          String          @id @default(uuid())
  requestId   String
  description String
  quantity    Int
  unitPrice   Decimal         @db.Decimal(10, 2)
  totalPrice  Decimal         @db.Decimal(10, 2)
  request     PurchaseRequest @relation(fields: [requestId], references: [id])

  @@index([requestId], map: "RequestItem_requestId_fkey")
}

model PurchaseOrder {
  id          String          @id @default(uuid())
  requestId   String          @unique
  supplierId  String
  status      OrderStatus     @default(DRAFT)
  totalAmount Decimal         @db.Decimal(10, 2)
  issuedAt    DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  request     PurchaseRequest @relation(fields: [requestId], references: [id])
  supplier    Supplier        @relation(fields: [supplierId], references: [id])

  @@index([supplierId], map: "PurchaseOrder_supplierId_fkey")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  resource  String
  details   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "AuditLog_userId_fkey")
}

enum RequestStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  DRAFT
  SENT
  PARTIAL
  COMPLETED
  CANCELLED
}
